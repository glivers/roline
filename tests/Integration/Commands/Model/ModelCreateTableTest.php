<?php namespace Tests\Integration\Commands;

/**
 * Integration Tests for model:create-table command
 *
 * Tests the complete flow of creating database tables from model @column
 * annotations via the Roline CLI. These integration tests execute the actual
 * model:create-table command and verify that database tables are correctly created
 * with proper schema, columns, indexes, and constraints matching the model
 * annotations.
 *
 * What Gets Tested:
 *   - Basic table creation from model annotations
 *   - Column type mapping (@varchar, @int, @datetime, etc.)
 *   - Primary key and auto-increment detection
 *   - Timestamp columns (date_created, date_modified)
 *   - Table existence validation before creation
 *   - Model validation (class exists, table property defined)
 *   - User confirmation prompts (destructive operation)
 *   - DROP TABLE warning and data loss prevention
 *
 * Test Strategy:
 *   - Create test models with @column annotations
 *   - Execute model:create-table command via runCommand()
 *   - Verify table exists in MySQL database
 *   - Query information_schema to validate columns
 *   - Test auto-fix features (missing timestamps, missing primary key)
 *   - Test error cases (missing model, missing table property)
 *   - Cleanup: DROP TABLE after each test
 *
 * Database Requirements:
 *   - MySQL server must be running
 *   - Test database configured in config/database.php
 *   - Database user needs CREATE TABLE and DROP TABLE privileges
 *
 * Safety Features Tested:
 *   - Confirmation prompt before DROP/CREATE
 *   - Warning messages about data loss
 *   - Cancellation support
 *   - Validation before destructive operations
 *
 * File Cleanup:
 *   All created models and tables are automatically cleaned up after each test
 *   via tearDown() inherited from RolineTest base class.
 *
 * @author Geoffrey Okongo <code@rachie.dev>
 * @copyright 2015 - 2050 Geoffrey Okongo
 * @category Roline
 * @package Tests\Integration\Commands
 * @link https://github.com/glivers/roline
 * @license http://opensource.org/licenses/MIT MIT License
 * @version 1.0.0
 * @see RolineTest For base test functionality and cleanup mechanisms
 */

use Tests\RolineTest;

class ModelCreateTableTest extends RolineTest
{
    /**
     * Test creating basic table from model annotations
     *
     * Verifies that model:create-table successfully creates a database table from
     * a model generated by model:create command. This tests the full workflow
     * that developers will use: create model, then create table.
     *
     * What Gets Verified:
     *   - Model is created via model:create command
     *   - Generated model includes default columns (id, timestamps)
     *   - model:create-table command executes with 'yes' confirmation
     *   - Table exists in database after creation
     *   - Primary key column (id) exists and is auto-increment
     *   - Timestamp columns (date_created, date_modified) exist
     *
     * Test Flow:
     *   1. Create model via model:create command
     *   2. Run model:create-table command with confirmation
     *   3. Query database to verify table exists
     *   4. Verify column structure matches model
     *
     * @return void
     */
    public function testCreateBasicTable()
    {
        $modelName = 'Product';
        $tableName = 'products';
        $modelPath = TEST_MODELS_PATH . '/' . $modelName . 'Model.php';

        // Track for cleanup
        $this->trackFile($modelPath);
        $this->trackTable($tableName);

        // Delete if exists from previous test
        if (file_exists($modelPath)) {
            unlink($modelPath);
        }

        // Create model using model:create command (generates with default columns)
        $this->runCommand("model:create {$modelName}");
        $this->assertFileExists($modelPath);

        // Run model:create-table command with 'yes' confirmation
        $result = $this->runCommand("model:create-table {$modelName}", ['yes']);

        // Verify table was created in database
        $this->assertTableExists($tableName);

        // Verify default columns exist (from model stub)
        $this->assertColumnExists($tableName, 'id');
        $this->assertColumnExists($tableName, 'date_created');
        $this->assertColumnExists($tableName, 'date_modified');

        // Verify primary key
        $this->assertPrimaryKey($tableName, 'id');
    }

    /**
     * Test model:create-table requires model name argument
     *
     * Verifies that the command properly validates required arguments and provides
     * helpful error message when model name is missing.
     *
     * What Gets Verified:
     *   - Command detects missing model name argument
     *   - Error message contains 'required' or 'Model'
     *   - Command exits with error before attempting operations
     *
     * @return void
     */
    public function testRequiresModelNameArgument()
    {
        // Run command without model name
        $result = $this->runCommand('model:create-table');

        // Should show error about missing model name
        $output = strtolower($result['output']);
        $this->assertTrue(
            str_contains($output, 'required') || str_contains($output, 'model'),
            "Expected error about required model in output: {$result['output']}"
        );
    }

    /**
     * Test error handling for non-existent model
     *
     * Verifies that model:create-table gracefully handles the error case when attempting
     * to create a table from a model that doesn't exist.
     *
     * What Gets Verified:
     *   - Command detects when model class doesn't exist
     *   - Appropriate error message is displayed
     *   - No database operations are attempted
     *   - Helpful suggestion to create model first
     *
     * @return void
     */
    public function testCreateTableFromNonExistentModel()
    {
        $modelName = 'DoesNotExist';

        // Try to create table from non-existent model
        $result = $this->runCommand("model:create-table {$modelName}", ['yes']);

        // Should show error about model not found
        $output = strtolower($result['output']);
        $this->assertTrue(
            str_contains($output, 'not found') || str_contains($output, 'does not exist'),
            "Expected 'not found' error in output: {$result['output']}"
        );
    }

    /**
     * Test cancelling table creation
     *
     * Verifies that model:create-table allows user to cancel the destructive operation
     * when they respond 'no' to the confirmation prompt.
     *
     * What Gets Verified:
     *   - Model file is created first
     *   - Create command with 'no' confirmation cancels operation
     *   - Table is NOT created in database after cancellation
     *   - Cancellation message is displayed in output
     *
     * Safety Feature:
     *   Ensures users can safely back out of table creation if they change their mind.
     *
     * @return void
     */
    public function testCancelTableCreation()
    {
        $modelName = 'CancelTest';
        $tableName = 'cancel_tests';
        $modelPath = TEST_MODELS_PATH . '/' . $modelName . 'Model.php';

        $this->trackFile($modelPath);

        // Create model first
        $this->runCommand("model:create {$modelName}");
        $this->assertFileExists($modelPath);

        // Try to create table with 'no' confirmation (cancel)
        $result = $this->runCommand("model:create-table {$modelName}", ['no']);

        // Table should NOT be created
        $this->assertTableDoesNotExist($tableName);

        // Output should confirm cancellation
        $output = strtolower($result['output']);
        $this->assertTrue(
            str_contains($output, 'cancelled'),
            "Expected 'cancelled' in output: {$result['output']}"
        );
    }

    /**
     * Test table creation shows warning about data loss
     *
     * Verifies that model:create-table displays prominent warnings about the destructive
     * nature of the operation (DROP TABLE before CREATE TABLE).
     *
     * What Gets Verified:
     *   - Output contains warning about dropping existing table
     *   - Output mentions data loss
     *   - Warning is displayed BEFORE user confirmation
     *
     * @return void
     */
    public function testShowsDataLossWarning()
    {
        $modelName = 'WarningTest';
        $modelPath = TEST_MODELS_PATH . '/' . $modelName . 'Model.php';

        $this->trackFile($modelPath);

        // Create model
        $this->runCommand("model:create {$modelName}");

        // Run model:create-table with confirmation
        $result = $this->runCommand("model:create-table {$modelName}", ['no']);

        // Output should mention drop/data loss warning
        $output = strtolower($result['output']);
        $this->assertTrue(
            str_contains($output, 'drop') || str_contains($output, 'data') || str_contains($output, 'warning'),
            "Expected data loss warning in output: {$result['output']}"
        );
    }

    /**
     * Test recreating existing table (DROP then CREATE)
     *
     * Verifies that model:create-table can drop and recreate an existing table when
     * user confirms the destructive operation.
     *
     * What Gets Verified:
     *   - Table is created first time via model:create then model:create-table
     *   - Running model:create-table again drops and recreates table
     *   - Table still exists after recreation
     *   - Warning shown before drop operation
     *
     * @return void
     */
    public function testRecreateExistingTable()
    {
        $modelName = 'RecreateTest';
        $tableName = 'recreate_tests';  // snake_case + pluralized
        $modelPath = TEST_MODELS_PATH . '/' . $modelName . 'Model.php';

        $this->trackFile($modelPath);
        $this->trackTable($tableName);

        // Delete if exists from previous test
        if (file_exists($modelPath)) {
            unlink($modelPath);
        }

        // Create model and table using actual commands
        $this->runCommand("model:create {$modelName}");
        $this->runCommand("model:create-table {$modelName}", ['yes']);
        $this->assertTableExists($tableName);

        // Recreate table (should drop and recreate)
        $result = $this->runCommand("model:create-table {$modelName}", ['yes']);

        // Table should still exist after recreation
        $this->assertTableExists($tableName);

        // Output should indicate success
        $output = strtolower($result['output']);
        $this->assertTrue(
            str_contains($output, 'created') || str_contains($output, 'success'),
            "Expected success message in output: {$result['output']}"
        );
    }
}
