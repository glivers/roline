<?php namespace Tests\Integration\Commands;

/**
 * Integration Tests for db:export command
 *
 * Tests the complete flow of exporting entire database to SQL format via the
 * Roline CLI. These integration tests execute the actual db:export command and
 * verify that database exports are created with proper SQL statements.
 *
 * What Gets Tested:
 *   - Exporting database with custom filename
 *   - Auto-generated filenames with timestamps
 *   - Export file contains SQL CREATE TABLE statements
 *   - Overwrite confirmation for existing files
 *   - Success message display
 *
 * Test Strategy:
 *   - Export files are tracked via trackFile() for automatic cleanup
 *   - Commands are executed via runCommand() which captures output
 *   - File content assertions verify SQL statement inclusion
 *   - Output assertions verify success messages
 *   - Overwrite scenarios test confirmation prompts
 *
 * File Cleanup:
 *   All created export files are automatically removed after each test via
 *   tearDown() inherited from RolineTest base class. No manual cleanup required.
 *
 * @author Geoffrey Okongo <code@rachie.dev>
 * @copyright 2015 - 2050 Geoffrey Okongo
 * @category Roline
 * @package Tests\Integration\Commands
 * @link https://github.com/glivers/roline
 * @license http://opensource.org/licenses/MIT MIT License
 * @version 1.0.0
 * @see RolineTest For base test functionality and cleanup mechanisms
 */

use Tests\RolineTest;

class DbExportTest extends RolineTest
{
    /**
     * Test exporting database with custom filename
     *
     * Verifies that db:export command successfully exports the entire database
     * to SQL format using a user-specified filename.
     *
     * What Gets Verified:
     *   - Export file is created
     *   - File contains SQL CREATE TABLE statements
     *   - Success message is displayed
     *   - File is created in correct location
     *
     * @return void
     */
    public function testExportWithCustomFilename()
    {
        $exportFile = RACHIE_ROOT . '/application/storage/exports/db_test.sql';

        $this->trackFile($exportFile);

        $result = $this->runCommand("db:export db_test.sql");

        // Export file should exist
        $this->assertFileExists($exportFile, "Export file should be created");

        // File should contain SQL
        $content = file_get_contents($exportFile);
        $this->assertStringContainsString('CREATE TABLE', $content,
            "Export should contain CREATE TABLE statements");

        // Output should confirm success
        $output = strtolower($result['output']);
        $this->assertTrue(
            str_contains($output, 'complete') || str_contains($output, 'success') || str_contains($output, 'exported'),
            "Expected success message in output: {$result['output']}"
        );
    }

    /**
     * Test auto-generated filename
     *
     * Verifies that db:export command automatically generates a timestamped
     * filename when no filename is specified by the user.
     *
     * What Gets Verified:
     *   - Export file is created with auto-generated name
     *   - Filename includes timestamp pattern (YYYY-MM-DD_HHMMSS)
     *   - Export completes successfully
     *   - Filename is displayed in output
     *
     * @return void
     */
    public function testAutoGeneratedFilename()
    {
        $exportDir = RACHIE_ROOT . '/application/storage/exports';

        $result = $this->runCommand("db:export");

        // Find generated file (should match pattern: dbname_timestamp.sql)
        $files = glob($exportDir . '/*_*.sql');
        $this->assertNotEmpty($files, "Auto-generated export file should exist");

        // Track for cleanup
        if (!empty($files)) {
            foreach ($files as $file) {
                if (filemtime($file) > time() - 10) { // Created in last 10 seconds
                    $this->trackFile($file);
                    break;
                }
            }
        }

        // Filename should contain timestamp pattern
        $output = $result['output'];
        $this->assertMatchesRegularExpression(
            '/\d{4}-\d{2}-\d{2}_\d{6}/',
            $output,
            "Filename should contain timestamp: {$output}"
        );
    }

    /**
     * Test overwrite confirmation
     *
     * Verifies that db:export command prompts for confirmation when
     * attempting to overwrite an existing export file.
     *
     * What Gets Verified:
     *   - Initial export succeeds
     *   - Export file exists
     *   - Overwrite prompt is displayed
     *   - Declining overwrite cancels operation
     *   - Cancellation message is displayed
     *
     * @return void
     */
    public function testOverwriteConfirmation()
    {
        $exportFile = RACHIE_ROOT . '/application/storage/exports/overwrite_db.sql';

        $this->trackFile($exportFile);

        // Create initial export
        $this->runCommand("db:export overwrite_db.sql");
        $this->assertFileExists($exportFile);

        // Try to export again with 'no' (cancel overwrite)
        $result = $this->runCommand("db:export overwrite_db.sql", ['no']);

        $output = strtolower($result['output']);
        $this->assertTrue(
            str_contains($output, 'cancelled') || str_contains($output, 'cancel'),
            "Expected cancellation message: {$result['output']}"
        );
    }
}
